# نظام المصادقة البديل

هذا الملف يشرح نظام المصادقة البديل الذي تم إنشاؤه لتجاوز مشكلة "Database error granting user" في Supabase Auth.

## المشكلة

عند محاولة تسجيل الدخول، يظهر خطأ "Database error granting user" مع رمز الحالة 500 (Internal Server Error). هذا يشير إلى مشكلة في قاعدة البيانات Supabase نفسها، وليس في بيانات المستخدم.

## الحل

تم إنشاء نظام مصادقة بديل يتجاوز مشكلة Supabase Auth ويستخدم جدول profiles مباشرة:

1. إنشاء وظائف API مخصصة للتعامل مع المصادقة
2. تعديل ملفات المصادقة الحالية لاستخدام الوظائف الجديدة
3. إنشاء آلية تخزين للجلسة باستخدام localStorage

## التغييرات التي تم إجراؤها

### 1. إنشاء ملف `alternativeAuth.ts`

تم إنشاء ملف جديد يحتوي على وظائف المصادقة البديلة:
- `alternativeSignIn`: تسجيل الدخول باستخدام البريد الإلكتروني وكلمة المرور
- `alternativeSignOut`: تسجيل الخروج
- `getCurrentUserFromSession`: الحصول على المستخدم الحالي من الجلسة المخزنة
- `updateCurrentSession`: تحديث الجلسة الحالية

### 2. تعديل ملف `supabaseAuth.ts`

تم تعديل وظيفة `signInWithEmail` لاستخدام نظام المصادقة البديل:
- استخدام `alternativeSignIn` كطريقة أساسية للمصادقة
- الاحتفاظ بـ Supabase Auth كنسخة احتياطية

### 3. تعديل ملف `authStore.ts`

تم تعديل وظائف المخزن لاستخدام نظام المصادقة البديل:
- تعديل `checkAuth` للتحقق من الجلسة البديلة أولاً
- تعديل `signOut` لتسجيل الخروج من النظام البديل

### 4. تعديل ملف `Login.tsx`

تم تعديل معالجة الأخطاء في صفحة تسجيل الدخول:
- إضافة معالجة خاصة لخطأ "Database error granting user"
- عرض رسالة مناسبة للمستخدم عند استخدام نظام المصادقة البديل

### 5. إنشاء ملفات SQL

تم إنشاء عدة ملفات SQL لدعم نظام المصادقة البديل:
- `alternative_auth_functions.sql`: إنشاء وظائف SQL للتحقق من كلمة المرور وتسجيل المستخدمين
- `create_test_account_v2.sql`: إنشاء حساب اختبار جديد يعمل مع النظام البديل

## كيفية استخدام النظام البديل

1. قم بتنفيذ ملف `alternative_auth_functions.sql` في SQL Editor في لوحة تحكم Supabase
2. قم بتنفيذ ملف `create_test_account_v2.sql` لإنشاء حساب اختبار جديد
3. حاول تسجيل الدخول باستخدام الحساب الجديد (test@test.com / Kk010193#)

## آلية عمل النظام البديل

1. عند تسجيل الدخول، يحاول النظام البديل التحقق من صحة بيانات المستخدم باستخدام وظيفة RPC مخصصة
2. إذا نجح التحقق، يتم إنشاء جلسة مشفرة وتخزينها في localStorage
3. عند التحقق من حالة المصادقة، يتم التحقق من الجلسة المخزنة أولاً
4. عند تسجيل الخروج، يتم مسح الجلسة من localStorage

## ميزات النظام البديل

1. لا يعتمد على Supabase Auth، مما يتجاوز مشكلة "Database error granting user"
2. يستخدم تشفير AES لتخزين الجلسة بشكل آمن في localStorage
3. يدعم جميع وظائف المصادقة الأساسية (تسجيل الدخول، تسجيل الخروج، التحقق من حالة المصادقة)
4. يتكامل بسلاسة مع نظام المصادقة الحالي

## ملاحظات أمنية

1. هذا النظام هو حل مؤقت لتجاوز مشكلة في Supabase Auth
2. يستخدم تشفير AES لتخزين الجلسة، ولكن تخزين البيانات في localStorage ليس آمناً تماماً
3. في بيئة الإنتاج، يجب استخدام وظائف RPC آمنة للتحقق من كلمة المرور
4. يجب إصلاح المشكلة الأساسية في Supabase Auth في أقرب وقت ممكن
