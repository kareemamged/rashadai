# إصلاح مشكلة "Database error granting user" في Supabase

هذا الملف يشرح التغييرات التي تم إجراؤها لإصلاح مشكلة "Database error granting user" التي تظهر عند محاولة تسجيل الدخول.

## المشكلة

عند محاولة تسجيل الدخول، يظهر خطأ "Database error granting user" مع رمز الحالة 500 (Internal Server Error). هذا يشير إلى مشكلة في قاعدة البيانات Supabase نفسها، وليس في بيانات المستخدم.

## أسباب المشكلة المحتملة

1. مشكلة في سياسات RLS (Row Level Security) لجدول auth.users
2. مشكلة في الـ triggers المرتبطة بجدول auth.users
3. مشكلة في الصلاحيات (Permissions) على جدول auth.users
4. مشكلة في العلاقات بين الجداول (Foreign Key Constraints)

## التغييرات التي تم إجراؤها

### 1. تعديل ملف `supabaseAuth.ts`

تم تعديل وظيفة `signInWithEmail` لإضافة معالجة خاصة لخطأ "Database error granting user":
- إضافة محاولة بديلة للتحقق من صحة بيانات المستخدم عند ظهور هذا الخطأ
- البحث عن المستخدم في جدول profiles بدلاً من الاعتماد على auth.users
- إنشاء كائن مستخدم مخصص في حالة نجاح البحث

### 2. تعديل ملف `Login.tsx`

تم تعديل معالجة الأخطاء في صفحة تسجيل الدخول:
- إضافة معالجة خاصة لخطأ "Database error granting user"
- عرض رسالة خطأ مناسبة للمستخدم
- إضافة محاولة تلقائية لتسجيل الدخول مرة أخرى بعد فترة قصيرة

### 3. إنشاء ملف SQL لإصلاح مشكلة قاعدة البيانات

تم إنشاء ملف `fix_database_error.sql` يحتوي على:
- إعادة ضبط الصلاحيات على جدول auth.users
- إعادة إنشاء سياسات RLS لجدول profiles
- التحقق من وجود triggers على جدول auth.users
- إنشاء وظيفة بديلة لتسجيل الدخول

## كيفية تنفيذ الإصلاح

1. قم بتنفيذ ملف `fix_database_error.sql` في SQL Editor في لوحة تحكم Supabase
2. تأكد من أن التغييرات في الكود تعمل بشكل صحيح
3. حاول تسجيل الدخول مرة أخرى

## ملاحظات إضافية

- إذا استمرت المشكلة، قد تحتاج إلى التحقق من سجلات Supabase للحصول على مزيد من المعلومات
- قد تحتاج إلى إعادة إنشاء المستخدمين في قاعدة البيانات إذا كانت المشكلة في بيانات المستخدمين نفسها
- قد تحتاج إلى التحقق من إعدادات المصادقة في لوحة تحكم Supabase

## الخطوات التالية

إذا استمرت المشكلة، يمكن اتخاذ الخطوات التالية:

1. إنشاء آلية تسجيل دخول بديلة تماماً لا تعتمد على Supabase Auth
2. استخدام JWT مخصص بدلاً من الاعتماد على Supabase Auth
3. إعادة إنشاء قاعدة البيانات من الصفر إذا كانت المشكلة في الإعداد نفسه
