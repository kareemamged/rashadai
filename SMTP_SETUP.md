# إعداد خدمة البريد الإلكتروني باستخدام SMTP مباشرة

هذا الدليل يشرح كيفية إعداد خدمة البريد الإلكتروني في تطبيق RashadAI باستخدام SMTP مباشرة.

## نظرة عامة

تم تنفيذ نظام البريد الإلكتروني باستخدام:
1. خادم Node.js بسيط مع Express و Nodemailer
2. واجهة برمجة تطبيقات (API) لإرسال البريد الإلكتروني واختبار اتصال SMTP
3. تكامل مع التطبيق الأمامي لاستخدام هذا API

## متطلبات النظام

- Node.js (الإصدار 14 أو أحدث)
- npm أو yarn
- خادم SMTP (مثل Hostinger أو Gmail أو أي خدمة بريد إلكتروني أخرى)

## هيكل النظام

```
project/
├── src/                     # كود التطبيق الأمامي
│   ├── lib/
│   │   ├── emailService.ts  # وظائف إرسال البريد الإلكتروني
│   │   └── smtpService.ts   # وظائف التعامل مع SMTP
│   └── ...
└── server/                  # خادم البريد الإلكتروني
    ├── server.js            # كود الخادم
    ├── package.json         # تبعيات الخادم
    └── .env                 # متغيرات بيئية للخادم
```

## خطوات الإعداد

### 1. إعداد خادم البريد الإلكتروني

1. انتقل إلى مجلد `server`:
```bash
cd server
```

2. قم بتثبيت التبعيات:
```bash
npm install
# أو
yarn install
```

3. قم بتشغيل الخادم:
```bash
npm run dev
# أو
yarn dev
```

الخادم سيعمل على المنفذ 3001 بشكل افتراضي. يمكنك تغيير المنفذ من خلال ملف `.env`.

### 2. إعداد إعدادات SMTP في لوحة تحكم المسؤول

1. قم بتسجيل الدخول إلى لوحة تحكم المسؤول
2. انتقل إلى "إعدادات النظام" > "إعدادات البريد الإلكتروني"
3. أدخل إعدادات SMTP الخاصة بك:
   - **SMTP Host**: عنوان خادم SMTP (مثل `smtp.hostinger.com`)
   - **SMTP Port**: منفذ SMTP (عادة 465 للاتصال الآمن)
   - **Encryption**: نوع التشفير (SSL أو TLS)
   - **SMTP Username**: اسم المستخدم (عادة عنوان البريد الإلكتروني)
   - **SMTP Password**: كلمة المرور
4. أدخل إعدادات نموذج الاتصال:
   - **From Email**: عنوان البريد الإلكتروني الذي سيظهر كمرسل
   - **To Email**: عنوان البريد الإلكتروني الذي سيستقبل رسائل نموذج الاتصال
   - **Subject Prefix**: بادئة موضوع البريد الإلكتروني
5. أدخل إعدادات نموذج الإبلاغ عن مشكلة:
   - **From Email**: عنوان البريد الإلكتروني الذي سيظهر كمرسل
   - **To Email**: عنوان البريد الإلكتروني الذي سيستقبل تقارير المشكلات
   - **Subject Prefix**: بادئة موضوع البريد الإلكتروني
6. انقر على "حفظ" لحفظ الإعدادات

### 3. اختبار اتصال SMTP

1. في صفحة إعدادات البريد الإلكتروني، انتقل إلى قسم "اختبار اتصال SMTP"
2. أدخل عنوان بريد إلكتروني للاختبار
3. انقر على "إرسال اختبار"
4. تحقق من صندوق البريد الوارد للعنوان المحدد للتأكد من استلام البريد الإلكتروني الاختباري

## كيفية عمل النظام

### خادم البريد الإلكتروني

خادم البريد الإلكتروني يوفر نقطتي نهاية API:

1. **إرسال بريد إلكتروني**:
   - `POST /api/send-email`
   - يستقبل إعدادات SMTP ومحتوى البريد الإلكتروني
   - يستخدم Nodemailer لإرسال البريد الإلكتروني

2. **اختبار اتصال SMTP**:
   - `POST /api/test-smtp`
   - يستقبل إعدادات SMTP وعنوان بريد إلكتروني للاختبار
   - يتحقق من صحة الاتصال ويرسل بريد إلكتروني اختباري

### التطبيق الأمامي

التطبيق الأمامي يستخدم ملفين رئيسيين للتعامل مع البريد الإلكتروني:

1. **emailService.ts**:
   - يوفر وظائف عالية المستوى لإرسال البريد الإلكتروني
   - يستخدم إعدادات SMTP من متجر الإدارة

2. **smtpService.ts**:
   - يوفر وظائف منخفضة المستوى للتعامل مع SMTP
   - يتواصل مع خادم البريد الإلكتروني لإرسال البريد الإلكتروني واختبار الاتصال

## استكشاف الأخطاء وإصلاحها

### مشكلة: خطأ "Connection refused"

- تأكد من أن خادم البريد الإلكتروني يعمل على المنفذ الصحيح
- تأكد من أن عنوان URL في ملف `smtpService.ts` يشير إلى العنوان الصحيح للخادم

### مشكلة: خطأ "Authentication failed"

- تأكد من صحة اسم المستخدم وكلمة المرور في إعدادات SMTP
- تأكد من أن خادم SMTP يسمح بالوصول من التطبيق

### مشكلة: خطأ "Connection timed out"

- تأكد من أن خادم SMTP متاح ويعمل
- تأكد من أن المنفذ المحدد صحيح وغير محظور بواسطة جدار الحماية

### مشكلة: البريد الإلكتروني لا يصل

- تحقق من مجلد البريد غير المرغوب فيه
- تأكد من أن عنوان البريد الإلكتروني المستلم صحيح
- تحقق من سجلات الخادم للتأكد من إرسال البريد الإلكتروني بنجاح

## نصائح للإنتاج

1. **الأمان**:
   - استخدم HTTPS لحماية البيانات المرسلة بين التطبيق الأمامي وخادم البريد الإلكتروني
   - قم بتنفيذ المصادقة والتفويض للوصول إلى نقاط النهاية API
   - لا تخزن كلمات المرور في النص العادي

2. **الأداء**:
   - استخدم قائمة انتظار لإرسال البريد الإلكتروني لتجنب تأخير واجهة المستخدم
   - قم بتنفيذ آلية إعادة المحاولة للتعامل مع فشل إرسال البريد الإلكتروني

3. **المراقبة**:
   - قم بتنفيذ تسجيل شامل لتتبع نجاح وفشل إرسال البريد الإلكتروني
   - قم بإعداد تنبيهات للإخطار بفشل إرسال البريد الإلكتروني

---

للمزيد من المعلومات حول Nodemailer، يرجى زيارة [توثيق Nodemailer](https://nodemailer.com/about/).
