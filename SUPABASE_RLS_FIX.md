# إصلاح مشكلات سياسات RLS في Supabase

هذا الملف يشرح كيفية إصلاح مشكلات سياسات Row Level Security (RLS) في Supabase التي تؤثر على وظائف المدونة.

## المشكلة

عند محاولة الوصول إلى جدول `blog_posts` من خلال واجهة برمجة التطبيقات، قد تواجه خطأ 403 (Forbidden) أو رسالة "permission denied". هذا يحدث بسبب سياسات RLS المقيدة جدًا أو غير المكتملة.

## الحل

### 1. تنفيذ ملف SQL لإصلاح سياسات RLS

قم بتنفيذ ملف `fix_blog_posts_rls.sql` في محرر SQL في Supabase:

1. قم بتسجيل الدخول إلى لوحة تحكم Supabase
2. انتقل إلى SQL Editor
3. انسخ محتوى ملف `supabase/fix_blog_posts_rls.sql` والصقه في محرر SQL
4. قم بتنفيذ الاستعلام

هذا الملف سيقوم بما يلي:
- تمكين RLS على جدول `blog_posts`
- حذف السياسات الموجودة (إن وجدت)
- إنشاء سياسات جديدة أكثر تساهلاً للاختبار
- إعداد سياسات مماثلة لجدول `blog_comments`

### 2. التحقق من سياسات RLS الحالية

يمكنك التحقق من سياسات RLS الحالية من خلال تنفيذ الاستعلام التالي في محرر SQL:

```sql
SELECT
  schemaname,
  tablename,
  policyname,
  permissive,
  roles,
  cmd,
  qual,
  with_check
FROM
  pg_policies
WHERE
  tablename = 'blog_posts';
```

### 3. فهم سياسات RLS

سياسات RLS تتحكم في الوصول إلى الصفوف في الجداول. هناك أربعة أنواع من السياسات:

1. **SELECT**: تتحكم في قراءة البيانات
2. **INSERT**: تتحكم في إضافة بيانات جديدة
3. **UPDATE**: تتحكم في تحديث البيانات الموجودة
4. **DELETE**: تتحكم في حذف البيانات

في ملف الإصلاح، قمنا بإنشاء سياسة SELECT تسمح لأي شخص بقراءة البيانات من جدول `blog_posts` للاختبار. في بيئة الإنتاج، قد ترغب في تقييد هذا الوصول.

## سياسات RLS المقترحة للإنتاج

بعد الانتهاء من الاختبار، يمكنك استبدال سياسة SELECT المتساهلة بسياسة أكثر أمانًا:

```sql
-- سياسة SELECT أكثر أمانًا
DROP POLICY IF EXISTS blog_posts_select_policy ON blog_posts;
CREATE POLICY blog_posts_select_policy ON blog_posts
  FOR SELECT USING (
    published = true OR  -- المنشورات المنشورة متاحة للجميع
    auth.uid() = author_id OR  -- المؤلف يمكنه رؤية منشوراته
    EXISTS (  -- المسؤولون يمكنهم رؤية جميع المنشورات
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND profiles.role = 'admin'
    )
  );
```

## استكشاف الأخطاء وإصلاحها

### 1. خطأ 403 Forbidden

إذا كنت لا تزال تواجه خطأ 403، تحقق مما يلي:

1. **تأكد من تمكين RLS**: تأكد من تمكين RLS على الجدول
   ```sql
   ALTER TABLE blog_posts ENABLE ROW LEVEL SECURITY;
   ```

2. **تأكد من وجود سياسات**: تأكد من وجود سياسات للجدول
   ```sql
   SELECT * FROM pg_policies WHERE tablename = 'blog_posts';
   ```

3. **تأكد من صحة JWT**: تأكد من أن رمز JWT صالح ولم تنتهي صلاحيته

### 2. خطأ "permission denied"

إذا كنت تواجه خطأ "permission denied"، فقد يكون ذلك بسبب:

1. **عدم وجود سياسة مناسبة**: تأكد من وجود سياسة تسمح بالعملية التي تحاول القيام بها
2. **عدم تطابق الشروط**: تأكد من أن الشروط في سياسة RLS تنطبق على البيانات التي تحاول الوصول إليها
3. **مشكلة في المصادقة**: تأكد من أن المستخدم مصادق عليه بشكل صحيح

### 3. التحقق من المصادقة

يمكنك التحقق من حالة المصادقة من خلال:

```javascript
const { data: { user } } = await supabase.auth.getUser();
console.log('Current user:', user);
```

## حل مشكلة "permission denied for table users"

إذا واجهت خطأ "permission denied for table users" عند محاولة إنشاء منشورات نموذجية، فهذا يعني أن الكود يحاول الوصول إلى جدول `auth.users` عند إنشاء المنشورات، ولكن المستخدم العادي لا يملك صلاحيات للوصول إلى هذا الجدول.

### الحل:

1. **استخدام معرف ثابت للمؤلف**: بدلاً من استخدام `user?.id` الذي يتطلب الوصول إلى جدول `auth.users`، قم باستخدام معرف ثابت للمؤلف في المنشورات النموذجية:

```javascript
// استخدام معرف ثابت للمؤلف بدلاً من user?.id
const adminAuthorId = '00000000-0000-0000-0000-000000000000';

const samplePosts = [
  {
    // ...
    author_id: adminAuthorId, // استخدام المعرف الثابت
    // ...
  }
];
```

2. **تعديل سياسات RLS**: قم بتعديل سياسات RLS لتكون أكثر تساهلاً أثناء الاختبار:

```sql
-- سياسة INSERT متساهلة للاختبار
CREATE POLICY blog_posts_insert_policy ON blog_posts
  FOR INSERT WITH CHECK (true);  -- السماح لأي شخص بالإدراج للاختبار
```

## ملاحظات إضافية

- **تجنب استخدام `true` في سياسات الإنتاج**: استخدام `true` في سياسات RLS يسمح لأي شخص بالوصول إلى البيانات، وهو مناسب للاختبار فقط
- **استخدم سياسات أكثر تقييدًا في الإنتاج**: في بيئة الإنتاج، استخدم سياسات أكثر تقييدًا تعتمد على هوية المستخدم ودوره
- **اختبر السياسات بعد تغييرها**: بعد تغيير السياسات، اختبر جميع وظائف التطبيق للتأكد من أنها تعمل بشكل صحيح
- **تأكد من وجود جدول profiles**: تأكد من وجود جدول `profiles` وأنه يحتوي على عمود `role` إذا كنت تستخدم سياسات تعتمد على دور المستخدم
